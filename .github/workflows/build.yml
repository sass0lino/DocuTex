      - name: Step 2 - Prepare Compile List
        id: prepare
        run: |
          echo "--- Preparing compile list ---"
          set +e  # Disabilita 'exit on error' per gestire casi senza output
          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.event.after }}"

          # Collect changed LaTeX files
          if [[ "$BEFORE_SHA" == "0000000000000000000000000000000000000000" ]]; then
            changed_files=$(git ls-tree --name-only -r "$AFTER_SHA" | grep '\.tex$' || true)
          else
            changed_files=$(git diff --name-only --diff-filter=AMR "$BEFORE_SHA" "$AFTER_SHA" -- 'src/*.tex' 'src/**/*.tex' || true)
          fi

          echo "$changed_files" > changed_raw.txt
          changed_parents=""

          # Only process if we have changed files
          if [ -s changed_raw.txt ]; then
            while IFS= read -r file; do
              [ -z "$file" ] && continue
              if [[ "$file" == *"/contenuti/"* ]]; then
                parent_dir=$(echo "$file" | sed 's|/contenuti/.*||')
                if [ -d "$parent_dir" ]; then
                  find "$parent_dir" -maxdepth 1 -type f -name "*.tex" || true
                fi
              else
                echo "$file"
              fi
            done < changed_raw.txt | sort -u > changed_parents.txt
          else
            > changed_parents.txt
          fi

          # Detect missing PDFs
          find src -type f -name "*.tex" ! -path "*/contenuti/*" 2>/dev/null | while IFS= read -r tex_file; do
            pdf_file=$(echo "$tex_file" | sed 's|^src/|docs/|; s|\.tex$|\.pdf|')
            [ ! -f "$pdf_file" ] && echo "$tex_file"
          done > missing_pdfs.txt || true

          # Merge both lists (if they exist)
          touch changed_parents.txt missing_pdfs.txt
          master_compile_list=$(cat changed_parents.txt missing_pdfs.txt | sort -u)

          if [ -z "$master_compile_list" ]; then
            echo "No .tex files to compile."
            echo "compile_needed=false" >> $GITHUB_OUTPUT
          else
            echo "$master_compile_list" > compile_list.txt
            echo "compile_needed=true" >> $GITHUB_OUTPUT
            echo "Files to compile:"
            cat compile_list.txt
          fi
          set -e  # Riabilita controllo errori
