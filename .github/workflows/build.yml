name: Build LaTeX documents

permissions:
Â  contents: write

on:
  push:
    branches:
      - main
    paths:
      - 'src/**/*.tex'
      - 'docs/**/*.pdf'

concurrency:
Â  group: latex-build
Â  cancel-in-progress: true

jobs:
Â  build_latex:
Â  Â  runs-on: ubuntu-latest

Â  Â  steps:
Â  Â  Â  - name: Checkout repository
Â  Â  Â  Â  uses: actions/checkout@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  fetch-depth: 0

Â  Â  Â  - name: Step 1 - Enforce Consistency (Cleanup)
Â  Â  Â  Â  id: analysis
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "--- Enforcing repository consistency ---"
Â  Â  Â  Â  Â  BEFORE_SHA="${{ github.event.before }}"
Â  Â  Â  Â  Â  AFTER_SHA="${{ github.event.after }}"

Â  Â  Â  Â  Â  # 1. Pulizia PDF orfani
Â  Â  Â  Â  Â  if [ -d "docs" ]; then
Â  Â  Â  Â  Â  Â  find docs -type f -name "*.pdf" | while IFS= read -r pdf_file; do
Â  Â  Â  Â  Â  Â  Â  src_file=$(echo "$pdf_file" | sed 's|^docs/|src/|; s|\.pdf$|\.tex|')
Â  Â  Â  Â  Â  Â  Â  if [ ! -f "$src_file" ]; then
Â  Â  Â  Â  Â  Â  Â  Â  echo "Deleting orphan PDF: $pdf_file"
Â  Â  Â  Â  Â  Â  Â  Â  rm -f -- "$pdf_file"
Â  Â  Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  Â  done
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  # 2. Pulizia PDF aggiunti a mano
Â  Â  Â  Â  Â  if [[ "$BEFORE_SHA" != "0000000000000000000000000000000000000000" ]]; then
Â  Â  Â  Â  Â  Â  manually_changed_pdfs=$(git diff --name-only --diff-filter=AMR "$BEFORE_SHA" "$AFTER_SHA" -- 'docs/**/*.pdf' || true)
Â  Â  Â  Â  Â  Â  if [ -n "$manually_changed_pdfs" ]; then
Â  Â  Â  Â  Â  Â  Â  echo "--> Manually modified PDFs detected. Deleting them:"
Â  Â  Â  Â  Â  Â  Â  echo "$manually_changed_pdfs" | while IFS= read -r pdf; do
Â  Â  Â  Â  Â  Â  Â  Â  [ -n "$pdf" ] && rm -f -- "$pdf"
Â  Â  Â  Â  Â  Â  Â  done
Â  Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  fi

Â  Â  Â  - name: Step 2 - Prepare Compile List (Unification)
Â  Â  Â  Â  id: prepare
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "--- Preparing compile list ---"

Â  Â  Â  Â  Â  # Trova lâ€™ultimo commit di build automatica come checkpoint
Â  Â  Â  Â  Â  LAST_COMPILED=$(git log --grep="^Automated LaTeX build" -n 1 --pretty=format:%H || echo "")
Â  Â  Â  Â  Â  if [ -z "$LAST_COMPILED" ]; then
Â  Â  Â  Â  Â  Â  echo "No previous build commit found. Performing full rebuild."
Â  Â  Â  Â  Â  Â  LAST_COMPILED=$(git rev-list --max-parents=0 HEAD)
Â  Â  Â  Â  Â  Â  BASE_DESC="(first commit)"
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  BASE_DESC="(base: $(echo $LAST_COMPILED | cut -c1-7))"
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  echo "Comparing changes since commit: $LAST_COMPILED $BASE_DESC"

Â  Â  Â  Â  Â  changed_parents_file="changed_parents.txt"
Â  Â  Â  Â  Â  > "$changed_parents_file"

Â  Â  Â  Â  Â  changed_files=$(git diff --name-only --diff-filter=AMR "$LAST_COMPILED" HEAD -- src | grep '\.tex$' || true)

Â  Â  Â  Â  Â  if [ -n "$changed_files" ]; then
Â  Â  Â  Â  Â  Â  echo "Changed .tex files detected:"
Â  Â  Â  Â  Â  Â  echo "$changed_files"
Â  Â  Â  Â  Â  Â  while IFS= read -r file; do
Â  Â  Â  Â  Â  Â  Â  [ -z "$file" ] && continue
Â  Â  Â  Â  Â  Â  Â  if [[ "$file" == *"/contenuti/"* ]]; then
Â  Â  Â  Â  Â  Â  Â  Â  parent_dir=$(echo "$file" | sed 's|/contenuti/.*||')
Â  Â  Â  Â  Â  Â  Â  Â  find "$parent_dir" -maxdepth 1 -type f -name "*.tex"
Â  Â  Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  Â  echo "$file"
Â  Â  Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  Â  done < <(echo "$changed_files") | sort -u > "$changed_parents_file"
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  # Scanner: trova tutti i .tex "padre" che non hanno il PDF corrispondente
Â  Â  Â  Â  Â  missing_pdfs_file="missing_pdfs.txt"
Â  Â  Â  Â  Â  > "$missing_pdfs_file"

Â  Â  Â  Â  Â  find src -type f -name "*.tex" | grep -v '/contenuti/' | while IFS= read -r tex_file; do
Â  Â  Â  Â  Â  Â  pdf_file=$(echo "$tex_file" | sed 's|^src/|docs/|; s|\.tex$|\.pdf|')
Â  Â  Â  Â  Â  Â  if [ ! -f "$pdf_file" ]; then
Â  Â  Â  Â  Â  Â  Â  echo "$tex_file" >> "$missing_pdfs_file"
Â  Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  done

Â  Â  Â  Â  Â  # Unisce le due fonti
Â  Â  Â  Â  Â  cat "$changed_parents_file" "$missing_pdfs_file" | sed '/^$/d' | sort -u > compile_list.txt

Â  Â  Â  Â  Â  echo "LAST_COMPILED=$LAST_COMPILED" >> $GITHUB_ENV
Â  Â  Â  Â  Â  echo "BASE_DESC=$BASE_DESC" >> $GITHUB_ENV

Â  Â  Â  Â  Â  if [ ! -s compile_list.txt ]; then
Â  Â  Â  Â  Â  Â  echo "No .tex files to compile."
Â  Â  Â  Â  Â  Â  echo "compile_needed=false" >> $GITHUB_OUTPUT

Â  Â  Â  Â  Â  Â  echo "# Report di compilazione del $(date -u --iso-8601=seconds)" > report.md
Â  Â  Â  Â  Â  Â  echo "" >> report.md
Â  Â  Â  Â  Â  Â  echo "ðŸ’¡ Nessun file modificato o mancante. Nessuna compilazione eseguita" >> report.md
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  echo "Files to compile:"
Â  Â  Â  Â  Â  Â  cat compile_list.txt
Â  Â  Â  Â  Â  Â  echo "compile_needed=true" >> $GITHUB_OUTPUT
Â  Â  Â  Â  Â  fi

Â  Â  Â  - name: Step 3 - Compile and Generate Build Report
Â  Â  Â  Â  if: steps.prepare.outputs.compile_needed == 'true'
Â  Â  Â  Â  uses: xu-cheng/latex-action@v3
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  enable-installer-cache: true
Â  Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  Â  echo "# Report di compilazione del $(date -u --iso-8601=seconds)" > report.md
Â  Â  Â  Â  Â  Â  echo "" >> report.md

Â  Â  Â  Â  Â  Â  build_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

Â  Â  Â  Â  Â  Â  echo "Compilazione basata sul commit ${LAST_COMPILED} ${BASE_DESC}" >> report.md
Â  Â  Â  Â  Â  Â  echo "" >> report.md

Â  Â  Â  Â  Â  Â  > successes.txt
Â  Â  Â  Â  Â  Â  > failures.txt

Â  Â  Â  Â  Â  Â  # Rimuove PDF esistenti per i file da ricompilare
Â  Â  Â  Â  Â  Â  while IFS= read -r texfile; do
Â  Â  Â  Â  Â  Â  Â  [ -z "$texfile" ] && continue
Â  Â  Â  Â  Â  Â  Â  pdf_file=$(echo "$texfile" | sed 's|^src/|docs/|; s|\.tex$|\.pdf|')
Â  Â  Â  Â  Â  Â  Â  [ -f "$pdf_file" ] && rm -f "$pdf_file"
Â  Â  Â  Â  Â  Â  done < compile_list.txt

Â  Â  Â  Â  Â  Â  mkdir -p tmp_build

Â  Â  Â  Â  Â  Â  # Blocco di compilazione (ex-docker)
Â  Â  Â  Â  Â  Â  # L'azione 'xu-cheng/latex-action' ha giÃ  installato TeX Live e messo 'latexmk' nel PATH
Â  Â  Â  Â  Â  Â  while IFS= read -r texfile || [ -n "$texfile" ]; do
Â  Â  Â  Â  Â  Â  Â  [ -z "$texfile" ] && continue
Â  Â  Â  Â  Â  Â  Â  echo "Compiling: $texfile"
Â  Â  Â  Â  Â  Â  Â  if latexmk -pdf -interaction=nonstopmode -file-line-error -output-directory="$(pwd)/tmp_build" "$texfile"; then

Â  Â  Â  Â  Â  Â  Â  Â  filepath=$(dirname "$texfile")
Â  Â  Â  Â  Â  Â  Â  Â  filename=$(basename "$texfile" .tex)
Â  Â  Â  Â  Â  Â  Â  Â  out_sub=$(echo "$filepath" | sed "s|^src/||; s|^src\$||")
Â  Â  Â  Â  Â  Â  Â  Â  out_dir="$(pwd)/docs/$out_sub"
Â  Â  Â  Â  Â  Â  Â  Â  mkdir -p "$out_dir"
Â  Â  Â  Â  Â  Â  Â  Â  mv "$(pwd)/tmp_build/$filename.pdf" "$out_dir/"
Â  Â  Â  Â  Â  Â  Â  Â  echo "$texfile;Success" >> build_result.log
Â  Â  Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  Â  echo "::error file=$texfile::LaTeX compilation failed"
Â  Â  Â  Â  Â  Â  Â  Â  echo "$texfile;Fail" >> build_result.log
Â  Â  Â  Â  Â  Â  Â  fi
Â  DÂ  Â  Â  Â  Â  Â  rm -rf "$(pwd)/tmp_build"/*
Â  Â  Â  Â  Â  Â  done < compile_list.txt
Â  Â  Â  Â  Â  Â  # Fine blocco compilazione

Â  Â  Â  Â  Â  Â  # Generazione report
Â  Â  Â  Â  Â  Â  echo "## Falliti" >> report.md
Â  Â  Â  Â  Â  Â  if grep -q ";Fail" build_result.log; then
Â  Â  DÂ  Â  Â  Â  Â  grep ";Fail" build_result.log | while IFS=";" read -r tex status; do
Â  Â  Â  Â  Â  Â  Â  Â  echo "âŒ [$tex]($build_url)" >> report.md
Â  Â  Â  Â  Â  Â  Â  Â  echo "" >> report.md
Â  Â  Â  Â  Â  Â  Â  done
Â  Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  echo "ðŸ’¡ Nessun errore di compilazione" >> report.md
Â  Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  Â  echo "" >> report.md
Â  Â  Â  Â  Â  Â  echo "## Compilati" >> report.md
Â  Â  Â  Â  Â  Â  if grep -q ";Success" build_result.log; then
Â  Â  Â  Â  Â  Â  Â  grep ";Success" build_result.log | while IFS=";" read -r tex status; do
Â  Â  Â  Â  Â  Â  Â  Â  pdf_path=$(echo "$tex" | sed 's|^src/|docs/|; s|\.tex$|\.pdf|')
Â  Â  Â  Â  Â  Â  Â  Â  enc=$(python3 -c "import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1]))" "$pdf_path")
Â  Â  Â  Â  Â  Â  Â  Â  echo "âœ… [$pdf_path]($enc)" >> report.md
Â  Â  Â  Â  Â  Â  Â  Â  echo "" >> report.md
Â  Â  Â  Â  Â  Â  Â  done
Â  Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  echo "ðŸ’¡ Nessun PDF compilato" >> report.md
Â  Â  Â  Â  Â  Â  fi

Â  Â  Â  - name: Step 4 - Commit Results
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "--- Committing results ---"
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # Aggiunge sempre il report
Â  Â  Â  Â  Â  git add -f report.md
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # Aggiunge docs solo se esiste
Â  Â  Â  Â  Â  if [ -d "docs" ]; then
Â  Â  Â  Â  Â  Â  git add docs
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  if git diff --staged --quiet; then
Â  Â  Â  Â  Â  Â  echo "No changes to commit."
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  git config --global user.name "github-actions[bot]"
Â  Â  Â  Â  Â  Â  git config --global user.email "github-actions[bot]@users.noreply.github.com"
Â  Â  Â  Â  Â  Â  COMMIT_MSG="Automated LaTeX build ${BASE_DESC}"
Â  Â  Â  Â  Â  Â  echo "Creating commit: $COMMIT_MSG"
Â  Â  Â  Â  Â  Â  git commit -m "$COMMIT_MSG"
Â  Â  Â  Â  Â  Â  git push
Â  Â  Â  Â  Â  fi
